name: üîò Manual CSKA Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: Checkout
      uses: actions/checkout@v4

    # 2. Setup Python 3.11
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 3. –ö—ç—à pip
    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

    # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest pytest-html

    # 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Chrome + ChromeDriver
    - name: Setup Chrome
      run: |
        # Google Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # ChromeDriver
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+')
        wget -q https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION%.*}
        CHROME_DRIVER_VERSION=$(cat LATEST_RELEASE_${CHROME_VERSION%.*})
        wget -q https://chromedriver.storage.googleapis.com/${CHROME_DRIVER_VERSION}/chromedriver_linux64.zip
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/bin/chromedriver
        sudo chmod +x /usr/bin/chromedriver

    # 6. üî• –ó–ê–ü–£–°–ö test_parser.py –ò–ó –ö–û–†–ù–Ø
    - name: Run test_parser.py
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º –í–°–ï —Ç–µ—Å—Ç—ã –∏–∑ test_parser.py
        pytest test_parser.py -v -s --html=test-report.html --self-contained-html

    # 7. –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    - name: Upload Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-report-${{ github.run_number }}
        path: test-report.html
        retention-days: 30
